name: atestsnap
summary: summary
description: |
  description
architectures:
  - amd64

version: '0.1'
base: core22
confinement: strict
grade: stable

environment:
  # WORKAROUND: Add python modules in Snap to search path
  PYTHONPATH: ${SNAP}/lib/python3.10/site-packages:${SNAP}/usr/lib/python3/dist-packages

apps:
  atestsnap:
    command: bin/chirp
    desktop: lib/python3.10/site-packages/chirp/share/chirp.desktop
    extensions:
      # HINT: gnome extension is incompatible with python apps. 
      # 
      - gnome
    plugs:
      - home
      - network
      - removable-media
      - raw-usb
      - serial-port

parts:
  atestsnap:
    plugin: python
    source: https://github.com/kk7ds/chirp.git
    stage-packages:
      - python3-requests
      - python3-serial
      - python3-six
      - python3-suds
      - python3-future
      - python3-yattag
      - python3-wxgtk4.0
    build-environment:
      # WORKAROUND: The python plugin is broken with gnome extension
      - PATH: ${CRAFT_PART_INSTALL}/bin:${PATH}
      - PYTHONPATH: ""
    override-pull: |
      sudo apt install -y curl
      ver=$(basename $(curl -Ls -o/dev/null -w '%{url_effective}' https://trac.chirp.danplanet.com/download?stream=next))
      curl -o ${SNAPCRAFT_PART_SRC}/chirp-src.tar.gz https://trac.chirp.danplanet.com/chirp_next/${ver}/chirp-${ver}.tar.gz
      tar -xz -C ${SNAPCRAFT_PART_SRC} -f ${SNAPCRAFT_PART_SRC}/chirp-src.tar.gz --strip-components=1
      # Until chirp version issue is fixed
      sed -i "s/version=CHIRP_VERSION/version=\"$(date +%Y%m%d)\"/g" ${SNAPCRAFT_PART_SRC}/setup.py
      # Fix icon
      sed -i 's,Icon=chirp,Icon=${SNAP}/lib/python3.10/site-packages/chirp/share/chirp.png,g' ${SNAPCRAFT_PART_SRC}/chirp/share/chirp.desktop
    stage:
      # WORKAROUND: Skip venv from python plugin
      - -bin/activate
      - -bin/activate.csh
      - -bin/activate.fish
      - -bin/Activate.ps1
      - -bin/python
      - -bin/python3
      - -bin/python3.10
      - -bin/pip
      - -bin/pip3
      - -bin/pip3.10
      - -pyvenv.cfg
